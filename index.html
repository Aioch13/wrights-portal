import React, { useState, useMemo, useCallback, useRef, useEffect } from 'react';
import {
  UserPlus, Calculator, Zap, CheckCircle, ChevronRight, ChevronLeft,
  Clock, Settings2, CalendarDays, Lock, Target, X, Download,
  Copy, Check, TrendingUp, FileText, Sun, BanIcon, CircleCheck, Key,
  Pencil, Archive
} from 'lucide-react';

// ─── DESIGN TOKENS ────────────────────────────────────────────────────────────
// Refined, desaturated palette — colour used sparingly as signal
const T = {
  // Surfaces
  bg:        '#F4F5F7',
  surface:   '#FFFFFF',
  border:    'border-zinc-200/70',
  borderSm:  'border-zinc-100',
  // Text
  hi:        'text-zinc-900',
  mid:       'text-zinc-500',
  lo:        'text-zinc-400',
  xlo:       'text-zinc-300',
  // Accent — muted indigo
  accent:    '#5A67D8',   // softer than indigo-600
  accentBg:  'bg-indigo-500/90',
  accentTxt: 'text-indigo-500',
  accentMuted:'bg-indigo-50',
  // Status — desaturated
  liveGreen: '#34A583',  // teal-ish, not full emerald
  doneSlate: '#3D4451',
  rosterBlue:'#4A7FB5',
  availOrange:'#C8752A',
  unavailRed:'#B94040',
};

// ─── MOCK DATA ────────────────────────────────────────────────────────────────
const _today = new Date();
const dKey = (offset=0) => { const d=new Date(_today); d.setDate(d.getDate()+offset); return d.toISOString().split('T')[0]; };
const MOCK_EMPLOYEES = [
  {id:1,name:'Sarah Chen',  archived:false},
  {id:2,name:'Marcus Webb', archived:false},
  {id:3,name:'Priya Sharma',archived:false},
  {id:4,name:'Tom Nguyen',  archived:false},
  {id:5,name:'Leila Frost', archived:false},
  {id:6,name:'Jake Mercer', archived:false},
];
const MOCK_SHIFTS = {
  [dKey(0)]:  {1:{stageIdx:2,startTime:'08:00'},2:{stageIdx:2,startTime:'09:00'},3:{stageIdx:1},4:{stageIdx:0},5:{stageIdx:1},6:{stageIdx:2,startTime:'07:30'}},
  [dKey(-1)]: {1:{stageIdx:3,startTime:'08:00',endTime:'16:30'},2:{stageIdx:3,startTime:'09:00',endTime:'17:00'},3:{stageIdx:3,startTime:'10:00',endTime:'18:00'},4:{stageIdx:3,startTime:'08:30',endTime:'16:00'},5:{stageIdx:0},6:{stageIdx:3,startTime:'07:30',endTime:'15:30'}},
  [dKey(-2)]: {1:{stageIdx:3,startTime:'08:00',endTime:'16:00'},2:{stageIdx:3,startTime:'09:00',endTime:'17:30'},3:{stageIdx:0},4:{stageIdx:3,startTime:'08:30',endTime:'16:30'},5:{stageIdx:3,startTime:'11:00',endTime:'19:00'},6:{stageIdx:0}},
  [dKey(-3)]: {1:{stageIdx:3,startTime:'08:00',endTime:'16:00'},2:{stageIdx:1},3:{stageIdx:3,startTime:'10:00',endTime:'18:00'},4:{stageIdx:0},5:{stageIdx:3,startTime:'11:00',endTime:'19:00'},6:{stageIdx:3,startTime:'07:30',endTime:'15:30'}},
  [dKey(1)]:  {1:{stageIdx:1},2:{stageIdx:1},3:{stageIdx:1},5:{stageIdx:1}},
  [dKey(2)]:  {1:{stageIdx:1},4:{stageIdx:1},6:{stageIdx:1}},
};
const MOCK_FLAGS    = {[dKey(-1)]:{5:2}};
const MOCK_HOLIDAYS = {[dKey(2)]:true};
const MOCK_PLANNING = {
  [dKey(3)]:{2:'available',5:'unavailable',6:'available'},
  [dKey(4)]:{3:'unavailable',4:'available'},
  [dKey(5)]:{1:'available',2:'unavailable'},
};

// ─── CONSTANTS ────────────────────────────────────────────────────────────────
const STAGES = [
  {id:'off',      label:'Off Duty',   icon:Clock,        bg:'bg-zinc-100',  text:'text-zinc-500', action:'Add to Roster', actionStyle:'bg-zinc-900 hover:bg-black text-white'},
  {id:'rostered', label:'Rostered',   icon:CalendarDays, bg:'bg-blue-50',   text:'text-blue-600', action:'Clock In Now',  actionStyle:'bg-[#4A7FB5] hover:bg-[#3d6fa3] text-white shadow-sm'},
  {id:'in',       label:'Live Shift', icon:Zap,          bg:'bg-emerald-50', text:'text-emerald-700', action:'End Shift', actionStyle:'bg-[#B94040] hover:bg-[#a33535] text-white shadow-sm'},
  {id:'out',      label:'Shift Ended',icon:CheckCircle,  bg:'bg-zinc-800',  text:'text-white',    action:null,            actionStyle:''},
];
const PLANNING_CYCLE = [null,'rostered','available','unavailable'];
const PLANNING_STYLES = {
  null:        {cell:'bg-zinc-100 hover:bg-zinc-200'},
  rostered:    {cell:'bg-[#93B4D4] hover:bg-[#82a8cc]',   badge:{bg:'bg-blue-50',    text:'text-[#4A7FB5]', icon:CalendarDays}},
  available:   {cell:'bg-[#E8A96A] hover:bg-[#e09c5a]',   badge:{bg:'bg-orange-50',  text:'text-[#C8752A]', icon:CircleCheck}},
  unavailable: {cell:'bg-[#C97070] hover:bg-[#bf6060]',   badge:{bg:'bg-red-50',     text:'text-[#B94040]', icon:BanIcon}},
};
const LEGEND_ITEMS = [
  {color:'bg-zinc-200',     label:'Off'},
  {color:'bg-[#93B4D4]',   label:'Rostered'},
  {color:'bg-[#E8A96A]',   label:'Available'},
  {color:'bg-[#C97070]',   label:'Unavailable'},
  {color:'bg-[#34A583]',   label:'Live'},
  {color:'bg-zinc-600',    label:'Ended'},
];
const MANAGER_PASSWORD = "1234";
const DAY_LABELS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

// ─── HELPERS ──────────────────────────────────────────────────────────────────
const parseHHMM = s => { if(!s) return null; const [h,m]=s.split(':').map(Number); return (isNaN(h)||isNaN(m))?null:h*60+m; };
const calcHours = (s,e) => { const a=parseHHMM(s),b=parseHHMM(e); if(a===null||b===null) return 0; const d=b-a; return d>0?Math.round(d/60*100)/100:0; };
const fmtHours  = h => { const hrs=Math.floor(h),mins=Math.round((h-hrs)*60); return mins>0?`${hrs}h ${mins}m`:`${hrs}h`; };
const fmtDecimal= h => `${h}h`;
const dateRange = (from,to) => { const days=[],d=new Date(from),end=new Date(to); d.setHours(0,0,0,0);end.setHours(0,0,0,0); while(d<=end){days.push(d.toISOString().split('T')[0]);d.setDate(d.getDate()+1);} return days; };
const getWeekMonday = date => { const d=new Date(date); d.setHours(0,0,0,0); const day=d.getDay(); d.setDate(d.getDate()-(day===0?6:day-1)); return d; };
const getWeekDays   = date => { const mon=getWeekMonday(date); return Array.from({length:7},(_,i)=>{ const d=new Date(mon); d.setDate(mon.getDate()+i); return d; }); };

// ─── WALKING CAT ─────────────────────────────────────────────────────────────
// Cat walks left→right across the card in a soft mint strip, loops seamlessly.
// Positioned between the times row and the action button on live shift cards.
const WalkingCat = () => (
  <div className="relative w-full overflow-hidden rounded-xl select-none pointer-events-none"
    style={{height:34, background:'linear-gradient(to right,#f0faf7,#eaf7f3,#f0faf7)'}}>
    <style>{`
      @keyframes wc-cross { 0%{transform:translateX(-50px)} 100%{transform:translateX(110%)} }
      @keyframes wc-bob   { 0%,100%{transform:translateY(0) rotate(-.5deg)} 50%{transform:translateY(-2px) rotate(.5deg)} }
      @keyframes wc-legA  { 0%,100%{transform:rotate(-18deg)} 50%{transform:rotate(18deg)} }
      @keyframes wc-legB  { 0%,100%{transform:rotate(18deg)}  50%{transform:rotate(-18deg)} }
      @keyframes wc-tail  { 0%,100%{transform:rotate(-10deg)} 50%{transform:rotate(10deg)} }
      @keyframes wc-ear   { 0%,72%,100%{transform:rotate(0)} 78%{transform:rotate(-9deg)} 88%{transform:rotate(5deg)} }
      @keyframes wc-blink { 0%,90%,100%{transform:scaleY(1)} 94%{transform:scaleY(0.1)} }
      .wc-wrap { animation: wc-cross 3.8s linear infinite; position:absolute; bottom:4px; left:0; }
      .wc-bob  { animation: wc-bob  .42s ease-in-out infinite; }
      .wc-lA   { animation: wc-legA .21s ease-in-out infinite; transform-origin:top center; }
      .wc-lB   { animation: wc-legB .21s ease-in-out infinite; transform-origin:top center; }
      .wc-lA2  { animation: wc-legB .21s ease-in-out infinite; transform-origin:top center; }
      .wc-lB2  { animation: wc-legA .21s ease-in-out infinite; transform-origin:top center; }
      .wc-tail { animation: wc-tail .42s ease-in-out infinite; transform-origin:0 50%; }
      .wc-ear  { animation: wc-ear  3.4s ease-in-out infinite; transform-origin:50% 100%; }
      .wc-eye  { animation: wc-blink 4.8s ease-in-out infinite; transform-origin:50% 50%; }
    `}</style>
    {/* faint ground line */}
    <div className="absolute bottom-0 left-0 right-0 h-px rounded-full" style={{background:'rgba(52,165,131,0.12)'}}/>
    {/* "on shift" label — quiet, right side */}
    <span className="absolute right-2.5 top-1/2 -translate-y-1/2 text-[8px] italic font-medium" style={{color:'rgba(52,165,131,0.45)'}}>on shift</span>
    <div className="wc-wrap">
      <svg width="44" height="26" viewBox="0 0 44 26" fill="none">
        <g className="wc-bob">
          {/* tail */}
          <g className="wc-tail" style={{transformOrigin:'6px 16px'}}>
            <path d="M6 16 Q1 12 2 6 Q3 2 5 4 Q6 5 4 8 Q2 12 5 15Z" fill="#2a9070"/>
          </g>
          {/* back legs */}
          <g className="wc-lB"  style={{transformOrigin:'12px 18px'}}><rect x="10.5" y="18" width="3" height="7" rx="1.5" fill="#268a6c"/></g>
          <g className="wc-lB2" style={{transformOrigin:'16px 18px'}}><rect x="14.5" y="18" width="3" height="7" rx="1.5" fill="#228060"/></g>
          {/* body */}
          <ellipse cx="21" cy="17" rx="12.5" ry="8" fill="#34A583"/>
          <ellipse cx="22" cy="19" rx="7.5" ry="4.5" fill="#3db896" opacity=".3"/>
          {/* front legs */}
          <g className="wc-lA"  style={{transformOrigin:'26px 21px'}}><rect x="24.5" y="21" width="3" height="7" rx="1.5" fill="#268a6c"/></g>
          <g className="wc-lA2" style={{transformOrigin:'31px 21px'}}><rect x="29.5" y="21" width="3" height="7" rx="1.5" fill="#228060"/></g>
          {/* head */}
          <circle cx="34" cy="12" r="9.5" fill="#34A583"/>
          {/* ears */}
          <g className="wc-ear" style={{transformOrigin:'29px 6px'}}>
            <polygon points="27,7 25,1 31,5" fill="#34A583"/><polygon points="28,7 26,2 30,5" fill="#238c6e"/>
          </g>
          <g className="wc-ear" style={{transformOrigin:'39px 6px'}}>
            <polygon points="37,7 37,1 43,5" fill="#34A583"/><polygon points="38,7 38,2 42,5" fill="#238c6e"/>
          </g>
          {/* eyes */}
          <g className="wc-eye" style={{transformOrigin:'31px 12px'}}>
            <ellipse cx="31" cy="12" rx="1.8" ry="2" fill="#0c1a15"/>
            <circle cx="31.6" cy="11" r=".65" fill="white" opacity=".7"/>
          </g>
          <g className="wc-eye" style={{transformOrigin:'37px 12px'}}>
            <ellipse cx="37" cy="12" rx="1.8" ry="2" fill="#0c1a15"/>
            <circle cx="37.6" cy="11" r=".65" fill="white" opacity=".7"/>
          </g>
          {/* nose + mouth */}
          <polygon points="34,15.5 32.8,17 35.2,17" fill="#1a6b50"/>
          <path d="M32.8 17.3 Q34 18.8 35.2 17.3" stroke="#1a6b50" strokeWidth=".7" fill="none" strokeLinecap="round"/>
          {/* whiskers */}
          <line x1="38" y1="14.5" x2="44" y2="13" stroke="#a8ead0" strokeWidth=".7" opacity=".8"/>
          <line x1="38" y1="16"   x2="44" y2="16" stroke="#a8ead0" strokeWidth=".7" opacity=".8"/>
          <line x1="38" y1="17.5" x2="44" y2="19" stroke="#a8ead0" strokeWidth=".7" opacity=".8"/>
        </g>
      </svg>
    </div>
  </div>
);

// ─── LIVE CLOCK — ticks every minute ──────────────────────────────────────────
const LiveDuration = ({startTime}) => {
  const [now,setNow] = useState(new Date());
  useEffect(()=>{ const t=setInterval(()=>setNow(new Date()),30000); return()=>clearInterval(t); },[]);
  const startMins = parseHHMM(startTime);
  if(startMins===null) return null;
  const elapsed = Math.floor((now.getHours()*60+now.getMinutes()) - startMins);
  if(elapsed<=0) return null;
  const h=Math.floor(elapsed/60),m=elapsed%60;
  return <span className="text-[9px] font-bold text-emerald-400/80 tabular-nums">{h>0?`${h}h ${m}m`:`${m}m`} live</span>;
};

// ─── AUDIT MODAL ──────────────────────────────────────────────────────────────
const AuditModal = ({employees,shifts,publicHolidays,onClose}) => {
  const todayStr     = new Date().toISOString().split('T')[0];
  const firstOfMonth = new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString().split('T')[0];
  const [fromDate,setFromDate] = useState(firstOfMonth);
  const [toDate,setToDate]     = useState(todayStr);
  const [copied,setCopied]     = useState(false);
  const [isAuth,setIsAuth]     = useState(false);

  const auditData = useMemo(()=>{
    const days=dateRange(fromDate,toDate);
    return employees.filter(e=>!e.archived).map(emp=>{
      let ordinaryHours=0,holidayHours=0,ordinaryDays=0,holidayDays=0;
      days.forEach(k=>{
        const shift=shifts[k]?.[emp.id];
        if(!shift||shift.stageIdx!==3) return;
        const hrs=calcHours(shift.startTime,shift.endTime);
        if(publicHolidays[k]){holidayHours+=hrs;holidayDays++;}
        else{ordinaryHours+=hrs;ordinaryDays++;}
      });
      return{emp,ordinaryHours:Math.round(ordinaryHours*100)/100,holidayHours:Math.round(holidayHours*100)/100,totalHours:Math.round((ordinaryHours+holidayHours)*100)/100,ordinaryDays,holidayDays,totalDays:ordinaryDays+holidayDays};
    });
  },[employees,shifts,publicHolidays,fromDate,toDate]);

  const totOrd=auditData.reduce((s,r)=>s+r.ordinaryHours,0);
  const totPH =auditData.reduce((s,r)=>s+r.holidayHours,0);
  const totAll=auditData.reduce((s,r)=>s+r.totalHours,0);

  const csv=[
    `WrightBTS Payroll Audit — ${fromDate} to ${toDate}`,
    `Generated: ${new Date().toLocaleString('en-AU')}`,``,
    `Employee,Ordinary Hours,Public Holiday Hours,Total Hours,Ordinary Days,Holiday Days,Total Days`,
    ...auditData.map(r=>`${r.emp.name},${r.ordinaryHours},${r.holidayHours},${r.totalHours},${r.ordinaryDays},${r.holidayDays},${r.totalDays}`),
    ``,`TOTALS,${Math.round(totOrd*100)/100},${Math.round(totPH*100)/100},${Math.round(totAll*100)/100},,`,
    ``,`--- XERO PAYROLL ENTRY GUIDE ---`,
    `Ordinary Hours     → Earnings Rate: "Ordinary Time Earnings"`,
    `Public Holiday Hrs → Earnings Rate: "Public Holiday Pay"`,
  ].join('\n');

  const handleCopy=()=>navigator.clipboard.writeText(csv).then(()=>{setCopied(true);setTimeout(()=>setCopied(false),2000);});
  const handleDownload=()=>{const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),download:`payroll-${fromDate}-${toDate}.csv`});a.click();};

  if(!isAuth) return(
    <div className="fixed inset-0 z-[200] bg-zinc-900/20 backdrop-blur-md flex items-center justify-center p-6">
      <div className="bg-white w-full max-w-sm rounded-2xl p-8 shadow-2xl border border-zinc-100">
        <div className="flex items-center gap-4 mb-8">
          <div className="w-10 h-10 bg-zinc-900 rounded-xl text-white flex items-center justify-center"><Lock size={18}/></div>
          <div><p className="text-base font-bold text-zinc-900 tracking-tight">Payroll Audit</p><p className="text-[10px] font-semibold text-zinc-400 uppercase tracking-widest">PIN required</p></div>
        </div>
        <input type="password" autoFocus placeholder="· · · ·"
          className="w-full py-5 bg-zinc-50 border border-zinc-200 rounded-xl font-bold text-3xl tracking-[0.5em] text-center outline-none focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all placeholder:text-zinc-300"
          maxLength={4} onChange={e=>e.target.value===MANAGER_PASSWORD&&setIsAuth(true)}/>
        <button onClick={onClose} className="w-full mt-4 text-zinc-300 text-[10px] font-semibold uppercase tracking-widest hover:text-zinc-400 transition-colors">Cancel</button>
      </div>
    </div>
  );

  return(
    <div className="fixed inset-0 z-[200] bg-zinc-900/20 backdrop-blur-md flex items-center justify-center p-4 overflow-y-auto">
      <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl my-4 overflow-hidden border border-zinc-100">
        {/* Header */}
        <div className="px-7 py-5 border-b border-zinc-100 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 bg-zinc-900 rounded-xl flex items-center justify-center"><FileText size={15} className="text-white"/></div>
            <div><p className="text-sm font-bold text-zinc-900 tracking-tight">Payroll Audit</p><p className="text-[9px] font-semibold text-zinc-400 uppercase tracking-widest">Xero-Ready Export</p></div>
          </div>
          <button onClick={onClose} className="p-2 text-zinc-400 hover:text-zinc-700 hover:bg-zinc-100 rounded-lg transition-all"><X size={16}/></button>
        </div>

        {/* Date controls */}
        <div className="px-7 py-3.5 border-b border-zinc-100 bg-zinc-50/60 flex items-center gap-4 flex-wrap">
          {[['From',fromDate,setFromDate],['To',toDate,setToDate]].map(([lbl,val,set])=>(
            <div key={lbl} className="flex items-center gap-2">
              <span className="text-[9px] font-bold text-zinc-400 uppercase tracking-widest w-6">{lbl}</span>
              <input type="date" value={val} onChange={e=>set(e.target.value)} className="px-3 py-1.5 bg-white border border-zinc-200 rounded-lg text-xs font-semibold text-zinc-700 outline-none focus:border-indigo-400 transition-all"/>
            </div>
          ))}
          <div className="flex gap-1.5 ml-auto flex-wrap">
            {[
              {l:'This Week',f:()=>{const m=getWeekMonday(new Date()),s=new Date(m);s.setDate(m.getDate()+6);setFromDate(m.toISOString().split('T')[0]);setToDate(s.toISOString().split('T')[0]);}},
              {l:'Last Week',f:()=>{const m=getWeekMonday(new Date());m.setDate(m.getDate()-7);const s=new Date(m);s.setDate(m.getDate()+6);setFromDate(m.toISOString().split('T')[0]);setToDate(s.toISOString().split('T')[0]);}},
              {l:'This Month',f:()=>{const d=new Date();setFromDate(new Date(d.getFullYear(),d.getMonth(),1).toISOString().split('T')[0]);setToDate(d.toISOString().split('T')[0]);}},
              {l:'Last Month',f:()=>{const d=new Date();setFromDate(new Date(d.getFullYear(),d.getMonth()-1,1).toISOString().split('T')[0]);setToDate(new Date(d.getFullYear(),d.getMonth(),0).toISOString().split('T')[0]);}},
            ].map(p=><button key={p.l} onClick={p.f} className="px-2.5 py-1 bg-white border border-zinc-200 text-zinc-500 rounded-md text-[9px] font-semibold uppercase tracking-wider hover:border-indigo-300 hover:text-indigo-600 transition-all">{p.l}</button>)}
          </div>
        </div>

        {/* Summary — 3 cols */}
        <div className="grid grid-cols-3 divide-x divide-zinc-100 border-b border-zinc-100">
          {[
            {label:'Ordinary Hours',value:fmtHours(totOrd),sub:`${auditData.reduce((s,r)=>s+r.ordinaryDays,0)} days`,val:totOrd,color:'text-zinc-800'},
            {label:'Public Holiday', value:fmtHours(totPH), sub:`${auditData.reduce((s,r)=>s+r.holidayDays,0)} days`, val:totPH, color:'text-[#B94040]'},
            {label:'Combined Total', value:fmtHours(totAll),sub:`${auditData.reduce((s,r)=>s+r.totalDays,0)} shifts`,val:totAll,color:'text-indigo-500'},
          ].map(s=>(
            <div key={s.label} className="px-6 py-4">
              <p className="text-[8px] font-bold text-zinc-400 uppercase tracking-widest mb-1">{s.label}</p>
              <p className={`text-xl font-bold tracking-tight ${s.color}`}>{s.value}</p>
              <p className="text-[9px] text-zinc-400 mt-0.5">{s.sub}</p>
            </div>
          ))}
        </div>

        {/* Employee rows */}
        <div className="px-7 py-4 space-y-1 max-h-[38vh] overflow-y-auto">
          {auditData.every(r=>r.totalDays===0) ? (
            <div className="text-center py-10 text-zinc-300">
              <FileText size={28} className="mx-auto mb-2 opacity-30"/>
              <p className="text-xs font-semibold uppercase tracking-widest">No completed shifts</p>
            </div>
          ) : auditData.map(row=>(
            <div key={row.emp.id} className="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-zinc-50 transition-colors">
              <div className="w-8 h-8 rounded-lg bg-zinc-100 flex items-center justify-center text-[11px] font-bold text-zinc-500 shrink-0">{row.emp.name[0]}</div>
              <div className="w-28 shrink-0">
                <p className="text-sm font-semibold text-zinc-800 leading-tight truncate">{row.emp.name}</p>
                <p className="text-[9px] text-zinc-400">{row.totalDays} shift{row.totalDays!==1?'s':''}</p>
              </div>
              <div className="flex-1">
                <p className="text-[8px] font-bold text-zinc-300 uppercase tracking-widest mb-0.5">Ordinary</p>
                <p className="text-sm font-bold text-zinc-700">{fmtHours(row.ordinaryHours)}</p>
                <p className="text-[9px] text-zinc-400">{fmtDecimal(row.ordinaryHours)} · {row.ordinaryDays}d</p>
              </div>
              <div className="flex-1">
                <p className="text-[8px] font-bold text-zinc-300 uppercase tracking-widest mb-0.5">Public Hol.</p>
                {row.holidayHours>0
                  ?<><p className="text-sm font-bold text-[#B94040]">{fmtHours(row.holidayHours)}</p><p className="text-[9px] text-red-300">{fmtDecimal(row.holidayHours)} · {row.holidayDays}d</p></>
                  :<p className="text-zinc-200 font-bold text-sm leading-none mt-1">—</p>}
              </div>
              <div className="shrink-0 text-right">
                <p className="text-[8px] font-bold text-zinc-300 uppercase tracking-widest mb-0.5">Total</p>
                <p className="text-base font-bold text-indigo-500">{fmtHours(row.totalHours)}</p>
              </div>
              <div className="w-8 h-8 bg-zinc-900 rounded-lg flex items-center justify-center text-[11px] font-bold text-white shrink-0">{row.totalDays}</div>
            </div>
          ))}
        </div>

        {/* Xero guide + export */}
        <div className="px-7 pb-6 pt-3 border-t border-zinc-100">
          <div className="bg-indigo-50/60 border border-indigo-100 rounded-xl px-5 py-3 mb-4 flex gap-6 flex-wrap">
            {[
              {dot:'bg-zinc-400',label:'Ordinary',code:'"Ordinary Time Earnings"'},
              {dot:'bg-[#C97070]',label:'Public Holiday',code:'"Public Holiday Pay"'},
            ].map(g=>(
              <div key={g.label} className="flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full ${g.dot} shrink-0`}/>
                <p className="text-[10px] text-indigo-700"><span className="font-bold">{g.label}</span> → <code className="font-mono bg-indigo-100/80 px-1 rounded text-indigo-700 text-[9px]">{g.code}</code></p>
              </div>
            ))}
          </div>
          <div className="flex gap-2.5">
            <button onClick={handleCopy} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-[10px] font-semibold uppercase tracking-widest transition-all ${copied?'bg-emerald-500 text-white':'bg-zinc-100 text-zinc-500 hover:bg-zinc-200'}`}>
              {copied?<Check size={13}/>:<Copy size={13}/>}{copied?'Copied!':'Copy CSV'}
            </button>
            <button onClick={handleDownload} className="flex items-center gap-2 px-5 py-2.5 bg-zinc-900 text-white rounded-xl text-[10px] font-semibold uppercase tracking-widest hover:bg-black transition-all active:scale-95">
              <Download size={13}/> Download CSV
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// ─── STAFF EDIT MODAL ─────────────────────────────────────────────────────────
const StaffEditModal = ({employee,onSave,onClose}) => {
  const [isAuth,setIsAuth]   = useState(false);
  const [name,setName]       = useState(employee.name);
  const [confirm,setConfirm] = useState(false);

  if(!isAuth) return(
    <div className="fixed inset-0 z-[200] bg-zinc-900/20 backdrop-blur-md flex items-center justify-center p-6">
      <div className="bg-white w-full max-w-xs rounded-2xl p-7 shadow-2xl border border-zinc-100">
        <div className="flex items-center gap-3 mb-7">
          <div className="w-9 h-9 bg-indigo-500 rounded-xl text-white flex items-center justify-center"><Pencil size={15}/></div>
          <div><p className="text-sm font-bold text-zinc-900">Edit Staff</p><p className="text-[9px] font-semibold text-zinc-400 uppercase tracking-widest">PIN required</p></div>
        </div>
        <input type="password" autoFocus placeholder="· · · ·"
          className="w-full py-5 bg-zinc-50 border border-zinc-200 rounded-xl font-bold text-2xl tracking-[0.5em] text-center outline-none focus:border-indigo-400 transition-all placeholder:text-zinc-300"
          maxLength={4} onChange={e=>e.target.value===MANAGER_PASSWORD&&setIsAuth(true)}/>
        <button onClick={onClose} className="w-full mt-4 text-zinc-300 text-[9px] font-semibold uppercase tracking-widest hover:text-zinc-400 transition-colors">Cancel</button>
      </div>
    </div>
  );

  if(confirm) return(
    <div className="fixed inset-0 z-[200] bg-zinc-900/20 backdrop-blur-md flex items-center justify-center p-6">
      <div className="bg-white w-full max-w-xs rounded-2xl p-7 shadow-2xl border border-zinc-100">
        <div className="w-10 h-10 bg-red-50 border border-red-100 rounded-xl flex items-center justify-center mb-5"><Archive size={18} className="text-[#B94040]"/></div>
        <p className="text-base font-bold text-zinc-900 mb-1">Archive {employee.name}?</p>
        <p className="text-xs text-zinc-400 mb-6 leading-relaxed">They'll be hidden from the active roster. All historical shift data is preserved.</p>
        <div className="flex gap-2.5">
          <button onClick={()=>setConfirm(false)} className="flex-1 py-3 bg-zinc-100 text-zinc-500 font-semibold rounded-xl text-[10px] uppercase tracking-widest">Cancel</button>
          <button onClick={()=>onSave({...employee,archived:true})} className="flex-1 py-3 bg-[#B94040] text-white font-semibold rounded-xl text-[10px] uppercase tracking-widest">Archive</button>
        </div>
      </div>
    </div>
  );

  return(
    <div className="fixed inset-0 z-[200] bg-zinc-900/20 backdrop-blur-md flex items-center justify-center p-6">
      <div className="bg-white w-full max-w-xs rounded-2xl p-7 shadow-2xl border border-zinc-100">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-9 h-9 rounded-xl bg-zinc-100 flex items-center justify-center font-bold text-zinc-500">{employee.name[0]}</div>
          <div><p className="text-sm font-bold text-zinc-900">Edit Staff Member</p><p className="text-[9px] text-zinc-400 uppercase tracking-widest font-semibold">Rename or archive</p></div>
        </div>
        <label className="text-[8px] font-bold text-zinc-400 uppercase tracking-widest ml-0.5 block mb-1.5">Display Name</label>
        <input type="text" value={name} onChange={e=>setName(e.target.value)}
          onKeyDown={e=>e.key==='Enter'&&name.trim()&&onSave({...employee,name:name.trim()})}
          className="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl font-semibold text-sm text-zinc-800 outline-none focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all mb-4" autoFocus/>
        <button onClick={()=>onSave({...employee,name:name.trim()||employee.name})} disabled={!name.trim()}
          className="w-full py-3 bg-zinc-900 text-white font-semibold rounded-xl text-[10px] uppercase tracking-widest disabled:opacity-30 active:scale-95 transition-all mb-3">
          Save Name
        </button>
        <button onClick={()=>setConfirm(true)}
          className="w-full py-2.5 flex items-center justify-center gap-1.5 border border-zinc-200 text-zinc-400 hover:border-red-200 hover:text-[#B94040] hover:bg-red-50 font-semibold rounded-xl text-[10px] uppercase tracking-widest transition-all">
          <Archive size={11}/> Archive Member
        </button>
        <button onClick={onClose} className="w-full mt-3.5 text-zinc-300 text-[9px] font-semibold uppercase tracking-widest hover:text-zinc-400 transition-colors">Cancel</button>
      </div>
    </div>
  );
};

// ─── MAIN APP ─────────────────────────────────────────────────────────────────
export default function App() {
  const [selectedDate,setSelectedDate]       = useState(new Date());
  const [viewMonth,setViewMonth]             = useState(new Date());
  const [employees,setEmployees]             = useState(MOCK_EMPLOYEES);
  const [shifts,setShifts]                   = useState(MOCK_SHIFTS);
  const [publicHolidays,setPublicHolidays]   = useState(MOCK_HOLIDAYS);
  const [planning,setPlanning]               = useState(MOCK_PLANNING);
  const [editingShift,setEditingShift]       = useState(null);
  const [editingEmployee,setEditingEmployee] = useState(null);
  const [isAddingEmployee,setIsAddingEmployee] = useState(false);
  const [newEmployee,setNewEmployee]         = useState({name:''});
  const [isAuth,setIsAuth]                   = useState(false);
  const [showAudit,setShowAudit]             = useState(false);
  const [showLegend,setShowLegend]           = useState(false);
  const legendTimer                          = useRef(null);

  const activeDateKey = selectedDate.toISOString().split('T')[0];
  const todayKey      = new Date().toISOString().split('T')[0];

  const saveData = useCallback((updates)=>{
    if(updates.employees)      setEmployees(updates.employees);
    if(updates.shifts)         setShifts(updates.shifts);
    if(updates.publicHolidays) setPublicHolidays(updates.publicHolidays);
    if(updates.planning)       setPlanning(updates.planning);
  },[]);

  const currentWeekDays = useMemo(()=>getWeekDays(selectedDate),[selectedDate]);
  const todayWeekMon    = useMemo(()=>getWeekMonday(new Date()).toISOString().split('T')[0],[]);
  const currentWeekKeys = useMemo(()=>currentWeekDays.map(d=>d.toISOString().split('T')[0]),[currentWeekDays]);
  const isCurrentWeek   = useMemo(()=>getWeekMonday(selectedDate).toISOString().split('T')[0]===todayWeekMon,[selectedDate,todayWeekMon]);

  const prevWeek    = ()=>{const d=new Date(selectedDate);d.setDate(d.getDate()-7);setSelectedDate(d);setViewMonth(new Date(d.getFullYear(),d.getMonth(),1));};
  const nextWeek    = ()=>{const d=new Date(selectedDate);d.setDate(d.getDate()+7);setSelectedDate(d);setViewMonth(new Date(d.getFullYear(),d.getMonth(),1));};
  const jumpToToday = ()=>{const t=new Date();setSelectedDate(t);setViewMonth(new Date(t.getFullYear(),t.getMonth(),1));};

  const weekLabel = useMemo(()=>{
    const mon=currentWeekDays[0],sun=currentWeekDays[6];
    return mon.getMonth()===sun.getMonth()
      ?`${mon.toLocaleDateString('en-GB',{day:'numeric'})} – ${sun.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}`
      :`${mon.toLocaleDateString('en-GB',{day:'numeric',month:'short'})} – ${sun.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}`;
  },[currentWeekDays]);

  const calendarDays = useMemo(()=>{
    const year=viewMonth.getFullYear(),month=viewMonth.getMonth();
    const fd=new Date(year,month,1).getDay(),dim=new Date(year,month+1,0).getDate();
    const sp=fd===0?6:fd-1,days=[];
    for(let i=0;i<sp;i++) days.push(null);
    for(let i=1;i<=dim;i++) days.push(new Date(year,month,i));
    return days;
  },[viewMonth]);

  const handleHeatmapClick = useCallback((empId,dateObj)=>{
    const k=dateObj.toISOString().split('T')[0];
    if(shifts[k]?.[empId]?.stageIdx>=2){setSelectedDate(new Date(dateObj));return;}
    const curr=planning[k]?.[empId]??null;
    const next=PLANNING_CYCLE[(PLANNING_CYCLE.indexOf(curr)+1)%PLANNING_CYCLE.length];
    saveData({planning:{...planning,[k]:{...planning[k],[empId]:next}}});
    setSelectedDate(new Date(dateObj));
  },[planning,shifts,saveData]);

  const setCardPlanning = useCallback((empId,dateKey,marker)=>{
    const curr=planning[dateKey]?.[empId]??null;
    saveData({planning:{...planning,[dateKey]:{...planning[dateKey],[empId]:curr===marker?null:marker}}});
  },[planning,saveData]);

  const getCellState = (empId,dateKey)=>{
    const s=shifts[dateKey]?.[empId];
    if(s?.stageIdx===2) return{type:'shift',state:'live'};
    if(s?.stageIdx===3) return{type:'shift',state:'done'};
    return{type:'plan',state:planning[dateKey]?.[empId]??null};
  };

  const getPlanMarker = (empId,dateKey)=>{
    if(shifts[dateKey]?.[empId]?.stageIdx>=2) return null;
    return planning[dateKey]?.[empId]??null;
  };

  const toggleHoliday = useCallback(()=>{
    const u={...publicHolidays,[activeDateKey]:!publicHolidays[activeDateKey]};
    if(!u[activeDateKey]) delete u[activeDateKey];
    saveData({publicHolidays:u});
  },[publicHolidays,activeDateKey,saveData]);

  return(
    <div className="flex h-screen font-sans overflow-hidden" style={{background:T.bg}}>

      {/* ── SIDEBAR ──────────────────────────────────────────────────────────── */}
      <aside className="w-[268px] flex flex-col bg-white border-r border-zinc-200/60 z-30 shrink-0">

        {/* Logo */}
        <div className="px-5 pt-5 pb-3 flex items-center gap-2.5">
          <div className="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm italic shadow-sm shrink-0" style={{background:'#5A67D8'}}>W</div>
          <h1 className="font-bold text-base tracking-tight text-zinc-900">Wright<span style={{color:'#5A67D8'}} className="italic">BTS</span></h1>
        </div>

        <div className="px-4 mb-4">
          <button onClick={jumpToToday} className="w-full flex items-center justify-center gap-1.5 py-2 bg-zinc-900 hover:bg-black text-white rounded-lg text-[10px] font-semibold uppercase tracking-widest transition-all active:scale-95">
            <Target size={11}/> Today
          </button>
        </div>

        {/* Mini Calendar */}
        <div className="px-4 mb-4">
          <div className="bg-zinc-50 border border-zinc-100 rounded-xl p-3.5">
            <div className="flex items-center justify-between mb-2.5">
              <button onClick={()=>setViewMonth(new Date(viewMonth.getFullYear(),viewMonth.getMonth()-1,1))} className="p-1 hover:bg-white rounded-md text-zinc-400 transition-all"><ChevronLeft size={13}/></button>
              <span className="text-[9px] font-bold uppercase tracking-widest text-zinc-400">{viewMonth.toLocaleDateString('en-GB',{month:'long',year:'numeric'})}</span>
              <button onClick={()=>setViewMonth(new Date(viewMonth.getFullYear(),viewMonth.getMonth()+1,1))} className="p-1 hover:bg-white rounded-md text-zinc-400 transition-all"><ChevronRight size={13}/></button>
            </div>
            <div className="grid grid-cols-7 gap-px">
              {['M','T','W','T','F','S','S'].map((d,i)=><div key={i} className="text-[7px] font-bold text-zinc-300 text-center pb-1">{d}</div>)}
              {calendarDays.map((date,i)=>{
                if(!date) return <div key={`e-${i}`}/>;
                const k=date.toISOString().split('T')[0];
                const isSel=k===activeDateKey,isTod=k===todayKey,inWeek=currentWeekKeys.includes(k);
                const pos=currentWeekKeys.indexOf(k),isPH=!!publicHolidays[k];
                let wBg='';
                if(inWeek&&!isSel) wBg=pos===0?'bg-indigo-50 rounded-l-md':pos===6?'bg-indigo-50 rounded-r-md':'bg-indigo-50 rounded-none';
                return(
                  <button key={k} onClick={()=>setSelectedDate(date)}
                    className={`relative w-7 h-7 flex items-center justify-center text-[9px] font-semibold transition-all
                      ${isSel?'rounded-md z-10 text-white':
                        isTod?`text-indigo-500 font-bold rounded-md ${inWeek?wBg:''}`:
                        inWeek?`text-indigo-400 ${wBg}`:
                        isPH?'bg-amber-50 text-amber-600 rounded-md font-semibold':
                        'text-zinc-400 hover:bg-white rounded-md'}`}
                    style={isSel?{background:'#5A67D8'}:{}}>
                    {date.getDate()}
                    {isPH&&!isSel&&<div className="absolute -top-px -right-px w-1.5 h-1.5 bg-amber-400 rounded-full border border-white"/>}
                    {isTod&&!isSel&&<div className="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full" style={{background:'#5A67D8'}}/>}
                  </button>
                );
              })}
            </div>
          </div>
        </div>

        {/* Heatmap */}
        <div className="px-4 pb-4 mt-auto">
          <div className="bg-white border border-zinc-200 rounded-xl p-4">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-1.5">
                <span className="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Weekly Roster</span>
                <div className="relative" onMouseEnter={()=>{clearTimeout(legendTimer.current);setShowLegend(true);}} onMouseLeave={()=>{legendTimer.current=setTimeout(()=>setShowLegend(false),300);}}>
                  <button className={`p-0.5 rounded transition-all ${showLegend?'text-indigo-400':'text-zinc-300 hover:text-zinc-400'}`}><Key size={10}/></button>
                  {showLegend&&(
                    <div className="absolute left-0 bottom-full mb-1.5 z-50 bg-white border border-zinc-200 rounded-xl p-3 shadow-xl w-36"
                      onMouseEnter={()=>{clearTimeout(legendTimer.current);setShowLegend(true);}} onMouseLeave={()=>{legendTimer.current=setTimeout(()=>setShowLegend(false),300);}}>
                      <p className="text-[7px] font-bold text-zinc-400 uppercase tracking-widest mb-2">Key</p>
                      <div className="space-y-1.5">
                        {LEGEND_ITEMS.map(x=><div key={x.label} className="flex items-center gap-2"><div className={`w-2.5 h-2.5 rounded-[3px] shrink-0 ${x.color}`}/><span className="text-[9px] font-medium text-zinc-500">{x.label}</span></div>)}
                      </div>
                      <p className="text-[7px] text-zinc-400 mt-2 pt-2 border-t border-zinc-100 leading-relaxed">Tap cells to cycle states</p>
                    </div>
                  )}
                </div>
              </div>
              <div className="flex gap-0.5">{DAY_LABELS.map((d,i)=><span key={i} className="text-[7px] font-bold text-zinc-200 w-3.5 text-center">{d}</span>)}</div>
            </div>

            <div className="space-y-2">
              {employees.filter(e=>!e.archived).map(emp=>(
                <div key={emp.id} className="flex items-center justify-between gap-2">
                  <button onClick={()=>setEditingEmployee(emp)}
                    className="text-[10px] font-medium text-zinc-400 truncate w-14 text-left hover:text-indigo-400 transition-colors flex items-center gap-1 group" title="Edit staff">
                    <span className="truncate">{emp.name.split(' ')[0]}</span>
                    <Pencil size={7} className="shrink-0 opacity-0 group-hover:opacity-100 transition-opacity text-indigo-300"/>
                  </button>
                  <div className="flex gap-1.5">
                    {currentWeekDays.map(date=>{
                      const k=date.toISOString().split('T')[0];
                      const isPH=!!publicHolidays[k];
                      const cell=getCellState(emp.id,k);
                      let color='';
                      let isLocked=false;
                      if(cell.type==='shift'){
                        if(cell.state==='live'){color='bg-[#34A583] shadow-[0_0_5px_rgba(52,165,131,0.4)]';isLocked=true;}
                        if(cell.state==='done'){color='bg-zinc-600';isLocked=true;}
                      } else {
                        color=PLANNING_STYLES[cell.state]?.cell||'bg-zinc-100 hover:bg-zinc-200';
                      }
                      return(
                        <button key={`${emp.id}-${k}`}
                          onClick={()=>isLocked?setSelectedDate(new Date(date)):handleHeatmapClick(emp.id,date)}
                          className={`w-3.5 h-3.5 rounded-[4px] transition-all hover:scale-110 ${color} ${isPH?'ring-2 ring-amber-300 ring-offset-[1px]':''}`}
                        />
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>

            <div className="flex items-center justify-between mt-3 pt-3 border-t border-zinc-100">
              <button onClick={prevWeek} className="p-1 hover:bg-zinc-100 rounded-md text-zinc-300 hover:text-zinc-500 transition-all"><ChevronLeft size={11}/></button>
              <span className="text-[7px] font-bold text-zinc-300 uppercase tracking-widest">
                {currentWeekDays[0]?.toLocaleDateString('en-GB',{day:'numeric',month:'short'})} — {currentWeekDays[6]?.toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
              </span>
              <button onClick={nextWeek} className="p-1 hover:bg-zinc-100 rounded-md text-zinc-300 hover:text-zinc-500 transition-all"><ChevronRight size={11}/></button>
            </div>
          </div>
        </div>
      </aside>

      {/* ── MAIN ─────────────────────────────────────────────────────────────── */}
      <main className="flex-1 flex flex-col overflow-hidden">

        {/* Weekly nav bar — fixed 72px, no layout shift */}
        <div className={`border-b transition-colors duration-500 shrink-0 ${isCurrentWeek?'bg-emerald-50/40 border-emerald-100/60':'bg-white border-zinc-200/60'}`}>
          <div className="flex items-center px-5 h-[72px] gap-2">
            <button onClick={prevWeek} className="p-1.5 hover:bg-zinc-100 rounded-lg text-zinc-300 hover:text-zinc-600 transition-all shrink-0"><ChevronLeft size={14}/></button>

            <div className="flex flex-1 gap-1 h-full items-center py-3">
              {currentWeekDays.map((date,idx)=>{
                const k=date.toISOString().split('T')[0];
                const isSel=k===activeDateKey,isTod=k===todayKey,isPH=!!publicHolidays[k];
                const staffOn=employees.filter(e=>!e.archived).filter(e=>shifts[k]?.[e.id]?.stageIdx>=1).length;
                return(
                  <button key={k} onClick={()=>setSelectedDate(date)}
                    className={`relative flex flex-col items-center justify-center flex-1 h-full rounded-xl transition-all duration-150
                      ${isSel
                        ?'text-white shadow-md'
                        :isPH
                          ?'bg-amber-50 text-amber-700 border border-amber-200/80'
                          :isTod
                            ?'bg-white text-indigo-500 border-2 shadow-sm'
                            :'hover:bg-zinc-50 text-zinc-400 hover:text-zinc-700'}`}
                    style={isSel?{background:'#5A67D8'}:isTod?{borderColor:'#5A67D8'}:{}}>
                    <span className={`text-[8px] font-bold uppercase tracking-widest leading-none mb-1 ${isSel?'opacity-60':''}`}>{DAY_LABELS[idx]}</span>
                    <span className="text-sm font-bold leading-none">{date.getDate()}</span>
                    {/* Staff pip — always in DOM, opacity-0 when empty */}
                    <span className={`mt-1 text-[7px] font-semibold px-1.5 py-px rounded-full leading-none transition-all duration-200
                      ${staffOn>0?(isSel?'bg-white/20 text-white opacity-100':'bg-indigo-50 text-indigo-400 opacity-100'):'opacity-0 pointer-events-none'}`}>
                      {staffOn||'·'}
                    </span>
                    {isPH&&!isSel&&<div className="absolute top-1.5 right-1.5 w-1.5 h-1.5 rounded-full bg-amber-400"/>}
                    {isSel&&isPH&&<div className="absolute top-1.5 right-1.5 w-1.5 h-1.5 rounded-full bg-white/50"/>}
                  </button>
                );
              })}
            </div>

            <button onClick={nextWeek} className="p-1.5 hover:bg-zinc-100 rounded-lg text-zinc-300 hover:text-zinc-600 transition-all shrink-0"><ChevronRight size={14}/></button>

            <div className="flex items-center gap-3 shrink-0 ml-1 pl-4 border-l border-zinc-200 h-10">
              <div className="text-right">
                <p className="text-[8px] font-bold text-zinc-400 uppercase tracking-widest">Pay Week</p>
                <p className="text-[10px] font-semibold text-zinc-700 whitespace-nowrap">{weekLabel}</p>
              </div>
              <button onClick={()=>setShowAudit(true)} className="flex items-center gap-1.5 px-3.5 py-2 rounded-lg text-[9px] font-semibold uppercase tracking-widest transition-all active:scale-95 whitespace-nowrap text-white"
                style={{background:'#3D4451',boxShadow:'0 1px 3px rgba(0,0,0,0.15)'}}>
                <Calculator size={11}/> Audit
              </button>
            </div>
          </div>
        </div>

        {/* Staff grid area */}
        <div className="flex-1 overflow-hidden px-5 pt-5 pb-4">
          <div className="h-full flex flex-col">

            {/* Date heading — slightly padded from nav bar */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2.5">
                <h2 className="text-xl font-bold tracking-tight text-zinc-900 leading-none">
                  {selectedDate.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'})}
                </h2>
                {publicHolidays[activeDateKey]&&(
                  <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-amber-50 border border-amber-200 text-amber-700 text-[9px] font-semibold">
                    <div className="w-1.5 h-1.5 rounded-full bg-amber-400"/>
                    Public Holiday
                  </span>
                )}
              </div>
              <button onClick={toggleHoliday}
                className={`text-[9px] font-semibold uppercase tracking-widest transition-all px-2.5 py-1.5 rounded-lg border
                  ${publicHolidays[activeDateKey]
                    ?'text-amber-600 bg-amber-50 border-amber-200 hover:bg-amber-100'
                    :'text-zinc-300 border-transparent hover:text-amber-600 hover:bg-amber-50 hover:border-amber-200'}`}>
                {publicHolidays[activeDateKey]?'✕ Remove Holiday':'+ Mark as Holiday'}
              </button>
            </div>

            {/* 3×2 grid */}
            <div className="grid grid-cols-3 gap-3 flex-1">
              {employees.filter(e=>!e.archived).slice(0,6).map(emp=>{
                const shift      = shifts[activeDateKey]?.[emp.id]||{stageIdx:0};
                const stage      = STAGES[shift.stageIdx]||STAGES[0];
                const isLive     = shift.stageIdx===2;
                const isDone     = shift.stageIdx===3;
                const hoursToday = calcHours(shift.startTime,shift.endTime);
                const planMarker = getPlanMarker(emp.id,activeDateKey);
                const isUnavail  = planMarker==='unavailable';
                const isAvail    = planMarker==='available';
                const isPH       = !!publicHolidays[activeDateKey];

                // Completed shift — hours display
                const hrsInt     = Math.floor(hoursToday);
                const minsInt    = Math.round((hoursToday-hrsInt)*60);

                return(
                  <div key={emp.id} className={`flex flex-col bg-white rounded-2xl p-4 border transition-all duration-300 min-h-0 overflow-hidden
                    ${isLive
                      ?'border-[#34A583]/30 ring-1 ring-[#34A583]/10'
                      :isUnavail
                        ?'border-[#C97070]/30 bg-[#fff8f8]'
                        :isPH
                          ?'border-amber-200/70 bg-amber-50/20'
                          :isDone
                            ?'border-zinc-200/60'
                            :'border-zinc-200/60 hover:border-zinc-300/80 hover:shadow-sm'}`}>

                    {/* Top: avatar + dots */}
                    <div className="flex items-start justify-between mb-3">
                      <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold shrink-0 transition-all
                        ${isLive?'text-white'
                          :isUnavail?'bg-[#fef2f2] text-[#C97070]'
                          :'bg-zinc-100 text-zinc-500'}`}
                        style={isLive?{background:'#34A583',boxShadow:'0 4px 12px rgba(52,165,131,0.3)'}:{}}>
                        {isUnavail?<BanIcon size={16}/>:emp.name[0]}
                      </div>
                      <div className="flex flex-col gap-1.5 pt-0.5">
                        <button onClick={()=>setCardPlanning(emp.id,activeDateKey,'available')} title="Available"
                          className={`w-3 h-3 rounded-full border-2 transition-all hover:scale-125 active:scale-90
                            ${isAvail?'border-[#C8752A]':'border-zinc-200 bg-white hover:border-[#C8752A]'}`}
                          style={isAvail?{background:'#C8752A',boxShadow:'0 0 6px rgba(200,117,42,0.4)'}:{}}/>
                        <button onClick={()=>setCardPlanning(emp.id,activeDateKey,'unavailable')} title="Unavailable"
                          className={`w-3 h-3 rounded-full border-2 transition-all hover:scale-125 active:scale-90
                            ${isUnavail?'border-[#B94040]':'border-zinc-200 bg-white hover:border-[#B94040]'}`}
                          style={isUnavail?{background:'#B94040',boxShadow:'0 0 6px rgba(185,64,64,0.35)'}:{}}/>
                      </div>
                    </div>

                    {/* Name + badge */}
                    <div className="mb-2.5">
                      <h4 className="text-sm font-semibold text-zinc-900 truncate leading-tight">{emp.name}</h4>
                      <div className="mt-1">
                        {shift.stageIdx>=2?(
                          <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[8px] font-semibold uppercase tracking-wider ${stage.bg} ${stage.text}`}>
                            {isLive?<Zap size={8} className="animate-pulse"/>:<stage.icon size={8}/>} {stage.label}
                          </span>
                        ):planMarker?(()=>{
                          const pb=PLANNING_STYLES[planMarker]?.badge;
                          if(!pb) return null;
                          const PBI=pb.icon;
                          return<span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[8px] font-semibold uppercase tracking-wider border ${pb.bg} ${pb.text}`}><PBI size={8}/>{planMarker}</span>;
                        })():(
                          <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[8px] font-semibold uppercase tracking-wider ${stage.bg} ${stage.text}`}>
                            <stage.icon size={8}/> {stage.label}
                          </span>
                        )}
                      </div>
                    </div>

                    {/* Times row */}
                    <div className="flex items-center gap-1 p-2.5 bg-zinc-50 rounded-xl border border-zinc-100 mb-2.5">
                      <div className="text-center flex-1">
                        <p className="text-[6px] font-bold text-zinc-300 uppercase tracking-widest mb-0.5">In</p>
                        <p className={`text-[10px] font-semibold leading-tight ${shift.startTime?'text-zinc-700':'text-zinc-300'}`}>{shift.startTime||'--:--'}</p>
                      </div>
                      <div className="w-px h-4 bg-zinc-200"/>
                      <div className="text-center flex-1">
                        <p className="text-[6px] font-bold text-zinc-300 uppercase tracking-widest mb-0.5">Out</p>
                        <p className={`text-[10px] font-semibold leading-tight ${shift.endTime?'text-zinc-700':'text-zinc-300'}`}>{shift.endTime||'--:--'}</p>
                      </div>
                      {/* Hours cell — show for live (elapsed) and done (actual) */}
                      {isLive&&(
                        <>
                          <div className="w-px h-4 bg-zinc-200"/>
                          <div className="text-center flex-1">
                            <p className="text-[6px] font-bold text-zinc-300 uppercase tracking-widest mb-0.5">Live</p>
                            <LiveDuration startTime={shift.startTime}/>
                          </div>
                        </>
                      )}
                      {isDone&&hoursToday>0&&(
                        <>
                          <div className="w-px h-4 bg-zinc-200"/>
                          <div className="text-center flex-1">
                            <p className="text-[6px] font-bold text-zinc-300 uppercase tracking-widest mb-0.5">Total</p>
                            {/* Two-line hours: decimal + h+m */}
                            <p className="text-[10px] font-bold text-indigo-500 leading-none">{hoursToday}h</p>
                            {minsInt>0&&<p className="text-[8px] font-medium text-zinc-400 leading-none mt-px">{hrsInt}h {minsInt}m</p>}
                          </div>
                        </>
                      )}
                    </div>

                    {/* Walking cat — live shifts only, sits between times row and action */}
                    {isLive&&(
                      <div className="mb-2.5">
                        <WalkingCat/>
                      </div>
                    )}

                    {/* Action */}
                    <div className="flex gap-1.5 mt-auto">
                      {isDone?(
                        <div className="flex-1 py-2.5 rounded-xl bg-zinc-50 border border-zinc-100 flex items-center justify-center gap-1.5">
                          <CheckCircle size={11} className="text-zinc-300"/>
                          <span className="text-[9px] font-semibold text-zinc-300 uppercase tracking-widest">Complete</span>
                        </div>
                      ):isUnavail?(
                        <div className="flex-1 py-2.5 rounded-xl bg-[#fff5f5] border border-[#fcd5d5] flex items-center justify-center gap-1.5">
                          <BanIcon size={11} className="text-[#C97070]"/>
                          <span className="text-[9px] font-semibold text-[#C97070] uppercase tracking-widest">Unavailable</span>
                        </div>
                      ):(
                        <button onClick={()=>{
                          const nextIdx=Math.min((shift.stageIdx+1)%STAGES.length,3);
                          const now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false});
                          const updated={...shift,stageIdx:nextIdx};
                          if(nextIdx===2) updated.startTime=now;
                          if(nextIdx===3) updated.endTime=now;
                          saveData({shifts:{...shifts,[activeDateKey]:{...shifts[activeDateKey],[emp.id]:updated}}});
                        }} className={`flex-1 py-2.5 rounded-xl text-[9px] font-semibold uppercase tracking-widest transition-all active:scale-95 ${stage.actionStyle}`}>
                          {stage.action}
                        </button>
                      )}
                      <button onClick={()=>setEditingShift({empId:emp.id,empName:emp.name,...shift})}
                        className="p-2.5 bg-zinc-100 text-zinc-400 rounded-xl hover:bg-zinc-900 hover:text-white transition-all">
                        <Settings2 size={12}/>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      </main>

      {/* ── OVERRIDE MODAL ───────────────────────────────────────────────────── */}
      {editingShift&&(
        <div className="fixed inset-0 z-[100] bg-zinc-900/20 backdrop-blur-md flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-xs rounded-2xl p-7 shadow-2xl border border-zinc-100">
            <div className="flex items-center gap-3 mb-7">
              <div className="w-10 h-10 rounded-xl text-white flex items-center justify-center" style={{background:'#5A67D8'}}><Lock size={17}/></div>
              <div><p className="text-sm font-bold text-zinc-900">{isAuth?editingShift.empName:'Verify Access'}</p><p className="text-[9px] font-semibold text-zinc-400 uppercase tracking-widest">{isAuth?'Edit Shift':'PIN: 1234'}</p></div>
            </div>
            {!isAuth?(
              <input type="password" autoFocus placeholder="· · · ·"
                className="w-full py-5 bg-zinc-50 border border-zinc-200 rounded-xl font-bold text-2xl tracking-[0.5em] text-center outline-none focus:border-indigo-400 transition-all placeholder:text-zinc-300"
                maxLength={4} onChange={e=>e.target.value===MANAGER_PASSWORD&&setIsAuth(true)}/>
            ):(
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-2">
                  {STAGES.slice(0,3).map((s,i)=>(
                    <button key={s.id} onClick={()=>setEditingShift({...editingShift,stageIdx:i})}
                      className={`flex items-center gap-1.5 p-3 rounded-xl border transition-all ${editingShift.stageIdx===i?'border-indigo-400 bg-indigo-50 text-indigo-500':'border-zinc-100 text-zinc-400 hover:border-zinc-200'}`}>
                      <s.icon size={11}/><span className="text-[9px] font-semibold uppercase tracking-widest">{s.label}</span>
                    </button>
                  ))}
                  <button onClick={()=>setEditingShift({...editingShift,stageIdx:3})}
                    className={`flex items-center gap-1.5 p-3 rounded-xl border transition-all ${editingShift.stageIdx===3?'border-indigo-400 bg-indigo-50 text-indigo-500':'border-zinc-100 text-zinc-400 hover:border-zinc-200'}`}>
                    <CheckCircle size={11}/><span className="text-[9px] font-semibold uppercase tracking-widest">Ended</span>
                  </button>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  {[['Clock In','startTime'],['Clock Out','endTime']].map(([lbl,field])=>(
                    <div key={field}>
                      <label className="text-[8px] font-bold text-zinc-400 uppercase tracking-widest ml-0.5 block mb-1">{lbl}</label>
                      <input type="text" className="w-full px-3 py-3 bg-zinc-50 border border-zinc-200 rounded-xl font-semibold text-center text-zinc-700 outline-none focus:border-indigo-400 text-sm"
                        value={editingShift[field]||''} onChange={e=>setEditingShift({...editingShift,[field]:e.target.value})}/>
                    </div>
                  ))}
                </div>
                <button onClick={()=>{
                  saveData({shifts:{...shifts,[activeDateKey]:{...shifts[activeDateKey],[editingShift.empId]:{stageIdx:editingShift.stageIdx,startTime:editingShift.startTime,endTime:editingShift.endTime}}}});
                  setEditingShift(null);setIsAuth(false);
                }} className="w-full py-3 bg-zinc-900 text-white font-semibold rounded-xl hover:bg-black transition-all active:scale-95 text-sm">Save Changes</button>
              </div>
            )}
            <button onClick={()=>{setEditingShift(null);setIsAuth(false);}} className="w-full mt-4 text-zinc-300 text-[9px] font-semibold uppercase tracking-widest hover:text-zinc-400 transition-colors">Dismiss</button>
          </div>
        </div>
      )}

      {/* ── ADD STAFF ────────────────────────────────────────────────────────── */}
      {isAddingEmployee&&(
        <div className="fixed inset-0 z-[100] bg-zinc-900/20 backdrop-blur-md flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-xs rounded-2xl p-7 shadow-2xl border border-zinc-100">
            <div className="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center text-zinc-400 mb-5"><UserPlus size={20}/></div>
            <p className="text-lg font-bold tracking-tight mb-0.5">New Staff Member</p>
            <p className="text-[10px] font-semibold text-zinc-400 uppercase tracking-widest mb-5">Add to roster</p>
            <input autoFocus type="text" placeholder="Full Name"
              className="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl font-semibold text-sm mb-5 outline-none focus:border-indigo-400 transition-all placeholder:text-zinc-300"
              value={newEmployee.name} onChange={e=>setNewEmployee({name:e.target.value})}
              onKeyDown={e=>{if(e.key==='Enter'&&newEmployee.name){setEmployees([...employees,{name:newEmployee.name,id:Date.now(),archived:false}]);setNewEmployee({name:''});setIsAddingEmployee(false);}}}
            />
            <div className="flex gap-2.5">
              <button onClick={()=>setIsAddingEmployee(false)} className="flex-1 py-3 bg-zinc-100 text-zinc-500 font-semibold rounded-xl text-[10px] uppercase tracking-widest">Cancel</button>
              <button onClick={()=>{if(!newEmployee.name)return;setEmployees([...employees,{name:newEmployee.name,id:Date.now(),archived:false}]);setNewEmployee({name:''});setIsAddingEmployee(false);}}
                className="flex-1 py-3 text-white font-semibold rounded-xl text-[10px] uppercase tracking-widest active:scale-95 transition-all" style={{background:'#5A67D8'}}>Register</button>
            </div>
          </div>
        </div>
      )}

      {editingEmployee&&<StaffEditModal employee={editingEmployee} onSave={emp=>{setEmployees(prev=>prev.map(e=>e.id===emp.id?emp:e));setEditingEmployee(null);}} onClose={()=>setEditingEmployee(null)}/>}
      {showAudit&&<AuditModal employees={employees} shifts={shifts} publicHolidays={publicHolidays} onClose={()=>setShowAudit(false)}/>}
    </div>
  );
}
